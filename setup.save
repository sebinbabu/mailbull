#!/usr/bin/env bash
# helper functions

ETC_HOSTS=/etc/hosts
PUBLIC_IP=$(dig +short myip.opendns.com @resolver1.opendns.com)
HOSTNAME=$(hostname)
USERID=$(id -u)
YUM="/usr/bin/yum -y"

read -p 'FQDN: ' FQDN
read -p 'Mail domain: ' SUBDOMAIN
read -p 'Email: ' EMAIL

function checkroot() {
	if [[ $USERID -ne 0 ]]; then
		echo "This script must be run as root"
		exit 1
	fi
}

function addhost() {
	IP=$1
	FQDN=$2
	HOSTNAME=$3

	HOSTS_LINE="$IP\t$FQDN\t$HOSTNAME"
	if [ -n "$(grep $HOSTNAME $ETC_HOSTS)" ]
	then
		echo "$HOSTNAME already exists : $(grep $HOSTNAME $ETC_HOSTS)"
	else
		echo "Adding $HOSTNAME to your $ETC_HOSTS";
		sudo -- sh -c -e "echo -e '$HOSTS_LINE' >> $ETC_HOSTS";

	if [ -n "$(grep $HOSTNAME $ETC_HOSTS)" ]
		then
			echo -e "$HOSTNAME was added succesfully \n $(grep $HOSTNAME $ETC_HOSTS)";
		else
			echo -e "Failed to Add $HOSTNAME, Try again!";
		fi
	fi
}

# Setup Certbot
function setup_certbot() {
	wget https://dl.eff.org/certbot-auto
	chmod a+x ./certbot-auto
	sudo ./certbot-auto certonly --standalone --debug -d $FQDN-d $SUBDOMAIN.$FQDN -n --agree-tos -m $EMAIL
}


# Setup Postfix
function setup_postfix() {
	$YUM update
	$YUM install postfix
	addhost $PUBLIC_IP $FQDN $HOSTNAME
	postconf -e "myhostname=$HOSTNAME"
	postconf -e "mydomain=$FQDN"
	postconf -e "myorigin=\$mydomain"
	postconf -e "inet_interfaces=all"
	postconf -e "inet_protocols=all"
	postconf -e "parameter=value"
}

checkroot
setup_certbot
setup_postfix

